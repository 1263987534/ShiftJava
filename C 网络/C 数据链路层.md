[TOC]

### 数据链路层

#### 概述

数据链路层的协议数据单元：**帧**。

数据链路层**作用**：将**网络层**交下来的数据报（分组）封**装成帧发送到链路**上，同时也可以取出接收到的帧中的数据交给网络层。

数据链路层像个**数字管道**。常常在两个对等的数据链路层之间画出一个数字管道，而在这条**数字管道**上传输的数据单位是**帧**。数据链路层不必考虑物理层如何实现比特传输的细节。甚至还可以更简单地设想好像是沿着两个数据链路层之间的水平方向把帧直接发送到对方。

<img src="assets/image-20191219204451010.png" alt="image-20191219204451010" style="zoom:45%;" />

#### 信道分类

信道有两种类型：

<img src="assets/image-20191219204335823.png" alt="image-20191219204335823" style="zoom:50%;" />

##### 1. 点对点信道

点对点信道是**一对一通信**。因为**不会发生碰撞**，因此也比较简单，使用 **PPP 协议**进行控制。

点对点信道通信流程：

- 结点 A 的数据链路层把**网络层**交下来的 IP 数据报**添加首部和尾部封装成帧**。

- 结点 A 把封装好的**帧**发给结点 **B** 的数据链路层。

- 若结点 B 的数据链路层收到的**帧无差错**，则从收到的帧中提取出 IP 数据报**上交**给网络层；否则丢弃这个帧（重发工作由上层完成，此处只确保无错传输）。

##### 2. 广播信道

广播信道是**一对多通信**，一个节点发送的数据能够被广播信道上**所有**的节点接收到。所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。主要有两种控制方法进行协调，一个是使用**信道复用**技术，一是使用 **CSMA/CD** 协议。



-----------------------------------------------------------------------------------------------------------------------------------------------------------

**==以下是使用点对点信道的数据链路层分析==**

-----------------------------------------------------------------------------------------------------------------------------------------------------------



#### 点对点信道三个基本问题

##### 1. 封装成帧

将网络层传下来的分组添加**首部和尾部**，用于**标记帧的开始和结束**。各种数据链路层协议对首部与尾部的格式都有明确的规定，**首部与尾部**的作用就是**帧定界**。控制字符 SOH 放在帧的最前面，控制字符 EOT 放在帧的最后面。

<img src="assets/image-20191219204616660.png" alt="image-20191219204616660" style="zoom:50%;" />

**MTU：最大传送单元**---即帧的数据部分的长度上限。

##### 2. 透明传输

透明表示一个实际存在的事物看起来好像不存在一样。

帧使用首部和尾部进行**定界**，如果帧的**数据部分**含有和**首部尾部**相同的内容，**那么帧的开始与结束位置就会被错误的判定**。如下图所示。

<img src="assets/image-20191219204647590.png" alt="image-20191219204647590" style="zoom:50%;" />

可以用“**字节填充法”**解决透明传输的问题。即在**数据部分**出现首部尾部**相同的内容**前面插入**转义字符**，这种方法称为**字符填充**。如果数据部分出现转义字符，那么就在转义字符前面再加个转义字符。在接收端进行处理之后可以**还原**出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。

<img src="assets/image-20191219204706661.png" alt="image-20191219204706661" style="zoom:50%;" />

##### 3. 差错检测

目前数据链路层广泛使用了**循环冗余检验**（CRC）来检查比特差错，这里所说的“差错”是“比特差错”，1 可能会变成 0 而 0 也可能变成 1。

在一段时间内，**传输错误的比特**占所传输**比特总数**的比率称为**误码率** BER (Bit Error Rate)。 **误码率**与**信噪比**有很大的关系。 为了保证数据传输的可靠性，在计算机网络传输数据时，必须采用各种差错检测措施。在数据后面添加上的**冗余码**称为**帧检验序列 FCS** (Frame Check Sequence)。

Tips: 在数据链路层使用 **CRC 检验**仅能够实现**无比特差错**的传输，也就是保证接收到的数据是**无比特差错**的，但这**不能保证可靠传输**(还需加入确认和重传的机制以防止**帧丢失**、**帧重复和帧失序**)。



#### PPP协议

**用处**：互联网用户通常需要连接到某个 **ISP** 之后才能接入到互联网，PPP 协议是**用户计算机和 ISP 进行通信**时所使用的数据链路层协议。

<img src="assets/image-20191219204822775.png" alt="image-20191219204822775" style="zoom:47%;" />

#####  1. PPP协议的特点

- **简单、封装成帧、透明性**、多种网络层协议，能够在同一条物理链路上同时支持多种网络层协议。
- 多种类型链路，能够在多种类型的链路上运行。
- **差错检测**，能够对接收端收到的帧进行检测，并立即丢弃有差错的帧。
- 检测连接状态，能够及时自动检测出链路是否处于正常工作状态。
- **最大传送单元**，必须对每一种类型的点对点链路设置最大传送单元 MTU 的标准默认值，促进各种实现之间的互操作性 。
- 网络层地址协商，必须提供一种机制使通信的两个网络层实体能够通过协商知道或能够配置彼此的网络层地址。 
- 数据压缩协商，必须提供一种方法来协商使用数据压缩算法。

##### 2. PPP协议的组成

- 一个将 **IP 数据报封装到串行链路**的方法（PPP 帧格式）。

- 链路控制协议 **LCP** (Link Control Protocol)。 
- 网络控制协议 **NCP** (Network Control Protocol)。 

##### 3. PPP协议帧格式

PPP 协议**面向字节**的，所有 PPP 帧的长度都是整数字节。 

PPP 帧的**首部和尾部**分别为 4 个字段和 2 个字段。标志字段 F = 0X7E（帧的定界符），地址字段A = 0xFF，控制字段通常  = 0x003，协议字段为 2 个字节：若为 0x0021，则信息字段就是 **IP 数据报**。 若为 0x8021，则信息字段是**网络控制数据**。 若为 0xC021，则信息字段是 **PPP 链路控制数据**。 若为 0xC023，则信息字段是**鉴别数据**。尾部的第一个字段（2个字节）是使用 CRC 的**帧检验序列**。

<img src="assets/image-20191219204848387.png" alt="image-20191219204848387" style="zoom:45%;" />

> 问题：在PPP协议中，透明传输中信息字段和标志字段的**比特组合一样**，又该如何处理呢？

这要分情况讨论，(1) 当 PPP 使用**异步传输**时，就要使用一种特殊的**字节填充法**（规定转义符定义为 0x7E）：将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列 (0x7D, 0x5E)。 若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列 (0x7D, 0x5D)。 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变。(2) 当 PPP 使用**同步传输**时（用在SONET/SDH链路），就要采用**零比特填充法**来实现透明传输：在发送端，只要发现有 **5 个连续 1**，则立即**填入一个 0**。 接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的**一个 0 删除**。

##### 4. PPP协议工作流程

PPP 协议的用处：用户使用拨号电话线接入互联网时， **用户计算机和 ISP 进行通信**时所使用的**数据链路层**协议就是 PPP 协议，看看到底是怎么在用户计算机和 ISP 之间**建立通信连接**的。

当**用户拨号接入 ISP** 时，路由器的调制解调器对拨号做出确认，并建立一条**物理连接**。 PC 机向路由器发送一系列的 **LCP 分组**（封装成多个 PPP 帧）。 这些分组及其响应选择一些 PPP 参数，并进行网络层配置，**NCP** 给新接入的 PC 机分配一个**临时的 IP 地址**，使 PC 机成为因特网上的一个主机。 通信完毕时，NCP 释放网络层连接，收回原来分配出去的 IP 地址。接着 LCP 释放数据链路层连接。最后释放的是物理层的连接。

<img src="assets/image-20191219204918116.png" alt="image-20191219204918116" style="zoom:45%;" />

 Tip: 由此可见 PPP 协议已不是纯粹的数据链路层的协议，它还包含了**物理层**和**网络层**的内容。 



-----------------------------------------------------------------------------------------------------------------------------------------------------------

**==以下是使用广播信道的数据链路层分析==**

-----------------------------------------------------------------------------------------------------------------------------------------------------------



**广播信道**可以进行**一对多**的通信，而==**局域网**使用的就是**广播信道**==，局域网技术非常重要，所以看看**局域网**的数据链路层。 

#### 局域网的数据链路层

##### 1. 局域网

局域网的**特点**：网络为一个**单位**所拥有，且**地理范围**和站点数目均**有限**。

**局域网的优点**：具有**广播功能**，从一个站点可很方便地访问全网。局域网上的主机可**共享**连接在局域网上的**各种硬件**和**软件资源**。 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变。 提高了系统的可靠性、可用性和残存性。

**局域网的分类**：按照网络拓扑分为**星形网**、**环形网**和**总线网**。

<img src="assets/image-20191219204938846.png" alt="image-20191219204938846" style="zoom:50%;" />

**注意**：局域网的工作层次跨越了==**数据链路层和物理层**==，但是技术多包含在数据链路层，所以这里讨论的是数据链路层中的局域网技术。 

为了使用户能够**共享资源**，就要考虑怎么**划分信道**，方式可以有 (1) **静态划分信道**：频分复用、时分复用、波分复用、码分复用等。(2) **动态媒体接入控制**(多点接入)：**随机接入**、受控接入，如多点线路探询 (polling)，或轮询等。

这里重点讨论**随机接入**方式：**所有的用户可以随机的发送信息**，但如果恰巧有两个或更多的用户在**同一时刻**发送信息，那么在共享媒体上就要产生**碰撞**，为此必须有**解决碰撞**的网络协议，即下述的 **CSMA/CD** 协议。 

##### 2. CSMA/CD协议

CSMA/CD 表示**载波监听多点接入 / 碰撞检测**。协议主要实现：

-  **多点接入** ：说明这是**总线型**网络，即许多主机以**多点**的方式连接到总线上。
-  **载波监听** ：**每个主机**都必须不停地**监听信道**。在发送前，如果监听到信道正在使用就必须**等待**。
-  **碰撞检测** ：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了**碰撞**。虽然每个主机在发送数据之前都已经监听到信道为**空闲**，但是由于电磁波的传播时延的存在，还是有**可能会发生碰撞**。

因此 CSMA/CD 要做的概括起来就是“**先听后发，边听边发，冲突停止，延迟重发**”。 

Tips: 在使用 CSMA/CD 协议时，一个站不可能同时进行发送和接受（但必须边发送边监听信道），所以使用 CSMA/CD 的以太网进行的是**双向交替通信**（半双工通信） 。

当发生碰撞时，主机要停止发送，**等待一段时间**再发送。这个时间采用  **截断二进制指数退避算法**  来确定。从离散的整数集合 {0, 1, .., (2<sup>k</sup>-1)} 中随机取出一个数，记作 r，然后取 r 倍的争用期作为**重传等待**时间。

<img src="assets/image-20191219205046604.png" alt="image-20191219205046604" style="zoom:50%;" />

##### 3. 网络适配器

**网络适配器** (adapter) 又称网络接口卡 **NIC** (Network Interface Card)，或“**网卡**”。

适配器的**重要功能**： **进行串行/并行转换**、**对数据进行缓存、数据的封装与解封、链路管理、**在计算机的操作系统安装设备驱动程序、 实现以太网协议。

当**适配器**收到正确的**帧**时，它就使用中断来通知计算机，并交付给**协议栈**中的**网络层**。当计算机要发送 IP 数据报时，就由协议栈把 IP 数据报向下交给适配器，组成**帧**后发送到**局域网**中。

<img src="assets/image-20191219205010925.png" alt="image-20191219205010925" style="zoom:45%;" />

##### 4. MAC地址

MAC 地址是固化在**网络适配器**的 **ROM** 中的，所以又叫**硬件地址**或**物理地址**。 **MAC 地址**是**==链路层地址==**，长度为 6 字节（48 位），用于唯一标识**网络适配器**（网卡）。其组成结构如下：

- 3 字节共 24 位：**组织唯一**标识符
- 3 字节共 24 位：**扩展唯一**标识符

一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

**适配器**从网络上每收到一个 **MAC 帧**就首先用硬件检查 **MAC 帧**中的 **MAC 地址**。 如果是发往本主机的帧则**收下**，然后上交给网络层进行处理。 否则就将此帧**丢弃**，不再进行其他的处理。 "发往本主机的帧" 包括以下三种帧： **单播 (unicast) 帧**（一对一） **广播 (broadcast) 帧**（一对全体） **多播 (multicast) 帧**（一对多） 。



#### 以太网

##### 1. 以太网概述

**以太网**是一种**星型拓扑**结构的**局域网**。早期使用**集线器**进行连接，但是已经被淘汰了。目前以太网使用**交换机**替代了集线器，交换机是一种**链路层设备**，它**不会发生碰撞**，能根据 **MAC 地址**进行存储转发。

**以太网帧**格式：

-  **类型** ：标记上层使用的**协议**；
-  **数据** ：长度在 46-1500 之间，如果太小则需要填充；
-  **FCS** ：帧检验序列，使用的是 **CRC** 检验方法；

<img src="assets/image-20191219205659633.png" alt="image-20191219205659633" style="zoom:50%;" />

##### 2. 交换机与以太网拓展

###### (1) 物理层拓展以太网

使用集线器，已经退出市场。

###### (2) 数据链路层拓展以太网

使用**交换机**。为了提高以太网的覆盖范围就需要扩展以太网，而最常用的方法就是在数据链路层扩展。早期使用**网桥**，现在使用**以太网交换机**。

**以太网交换机的特点**：本质上就是一个**多接口的网桥**。每个接口都直接与一个单台主机或另一个以太网交换机相连，并且一般都使用**全双工方式**。以太网交换机具有**并行性**（能够同时连通多对接口，使多对主机能同时通信），所以相互通信的主机都是独占传输媒体，无碰撞地传输数据。以太网交换机的接口有**存储器**，能在输出端口繁忙时把到来的**帧进行缓存**。 以太网交换机是一种**即插即用设备**，其内部的**帧交换表**（又称为**地址表**）是通过**自学习算法**自动地逐渐建立起来的。 以太网交换机使用了专用的交换结构芯片，用硬件转发，其转发速率要比使用软件转发的网桥快很多。

**以太网交换机的优点**：**用户独享带宽，增加了总容量**；从共享总线以太网转到交换式以太网时，所有接入设备的软件和硬件、适配器等都**不需要做任何改动**；有**多种速率的接口**，方便各种不同情况的用户。

**以太网交换机的交换方式**：大多对收到的帧采取**存储转发**的方式，少数采用直通的方式。

**以太网交换机的自学习**：查找**交换表**中与收到帧的**源地址**有无相匹配的项目。 如没有就在交换表中增加一个项目（源地址、进入的接口和有效时间）。 如有则把原有的项目进行更新（进入的接口或有效时间）。交换机具有**自学习**能力，学习的是==**交换表的内容，交换表中存储着 MAC 地址到接口的映射**==。正是由于这种自学习能力，因此交换机是一种**即插即用**设备，不需要网络管理员手动配置交换表内容。

下图中，交换机有 **4 个接口**，主机 A 向主机 B 发送数据帧时，交换机把主机 A 到接口 1 的**映射**写入交换表中。为了发送数据帧到 B，先查交换表，此时没有主机 B 的表项，那么主机 A 就发送**广播帧**，主机 C 和主机 D 会丢弃该帧，主机 B **回应**该帧向主机 A 发送数据包时，交换机**查找**交换表得到主机 A 映射的接口为 1，就发送数据帧到接口 1，同时交换机**添加**主机 B 到接口 2 的**映射**。

<img src="assets/1563548036004.png" alt="1563548036004" style="zoom:70%;" />

**以太网的转发帧流程**：查找交换表中与收到帧的**目的地址**有无相匹配的项目。 如没有则向**所有其他接口**（进入的接口除外）**转发**。 如有则按交换表中给出的接口进行转发。 若交换表中给出的接口就是该帧进入交换机的接口，则应丢弃这个帧（因为这时不需要经过交换机进行转发）。

现在**以太网交换机**的**星形结构**是以太网的**首选拓扑**。 **总线以太网**使用 **CSMA/CD 协议**，以半双工方式工作。而**以太网交**换机**不使用共享总线**，==**没有碰撞**==问题，因此**==不使用 CSMA/CD 协议==**，而是以**全双工方式工作**。但仍然**采用以太网的帧结构**。

##### 3. 虚拟局域网

虚拟局域网可以建立与**物理位置无关**的逻辑组，只有在**同一个虚拟局域网**中的成员才会收到链路层**广播信息**。

例如下图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。

使用 VLAN 干线连接来建立虚拟局域网，每台交换机上的一个特殊接口被设置为干线接口，以互连 VLAN 交换机。IEEE 定义了一种扩展的以太网帧格式 802.1Q，它在标准以太网帧上加进了 4 字节首部 VLAN 标签，用于表示该帧属于哪一个虚拟局域网。

<img src="assets/1563548061264.png" alt="1563548061264" style="zoom:70%;" />

















